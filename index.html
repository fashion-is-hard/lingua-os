<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>정경태 팀장님</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }
    .kakao-window {
      position: relative;
      width: 520px;
      height: min(760px, 94vh);
      background: #dfe3eb;
      border-radius: 10px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #aaa;
    }

    /* 상단 제목 영역 */
    .kakao-header {
      height: 50px;
      background: linear-gradient(to bottom, #f4f4f4, #dfdfdf);
      border-bottom: 1px solid #c2c2c2;
      display: flex;
      align-items: center;
      padding: 0 16px;
      color: #222;
    }
    .kakao-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    .profile-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      overflow: hidden;
      background: #bbb;
      flex-shrink: 0;
    }
    .profile-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .chat-title {
      font-size: 14px;
      font-weight: 600;
    }
    .member-count {
      font-size: 12px;
      color: #666;
      margin-left: 4px;
    }
    .kakao-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #666;
    }

    /* 채팅 영역 */
    .chat-body {
      flex: 1;
      background: #b8c3d1;
      padding: 12px 12px 6px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      max-width: 100%;
    }
    .msg-row.left {
      justify-content: flex-start;
    }
    .msg-row.right {
      justify-content: flex-end;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .msg-content {
      max-width: 75%;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .nickname {
      font-size: 11px;
      color: #333;
      margin-left: 4px;
    }
    .bubble {
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble.boss {
      background: #f0f5fb;
      border: 1px solid #a9b9d5;
    }
    .bubble.me {
      background: #ffe96b;
      border: 1px solid #e0c542;
    }
    .time {
      font-size: 10px;
      color: #555;
      margin: 0 4px;
      white-space: nowrap;
    }
    .msg-row.left .time { order: 3; }
    .msg-row.right .time { order: -1; }

    /* 하단 입력 영역 */
    .input-bar {
      background: #f0f1f4;
      border-top: 1px solid #c2c5d0;
      padding: 6px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-main {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .input-main textarea {
      flex: 1;
      resize: none;
      min-height: 50px;
      max-height: 140px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      font-size: 13px;
      padding: 6px 8px;
    }
    .input-main button {
      width: 72px;
      height: 44px;
      border-radius: 4px;
      border: 1px solid #c2c5d0;
      background: #f8f9fb;
      font-size: 12px;
      cursor: pointer;
    }

    /* === 문장 교정 팝업 === */
    .suggestion-popup {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      width: 360px;
      max-width: calc(100% - 40px);
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.35);
      border: 1px solid #e5e7eb;
      display: none;
      z-index: 20;
      overflow: hidden;
    }
    .suggestion-header {
      background: linear-gradient(90deg, #7c3aed, #ec4899);
      color: #ffffff;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
    }
    .suggestion-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .suggestion-title {
      font-size: 12px;
      font-weight: 600;
    }
    .suggestion-sub {
      font-size: 10px;
      opacity: 0.9;
    }
    .suggestion-close {
      cursor: pointer;
      font-size: 14px;
      opacity: 0.9;
    }
    .suggestion-body {
      padding: 10px 12px;
      background: #f9fafb;
    }
    .suggestion-info {
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 6px;
      background: #fef3c7;
      border: 1px solid #facc15;
      font-size: 11px;
      color: #92400e;
      display: none; /* 설명 없으면 숨김 */
    }
    .suggestion-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .suggestion-item {
      padding: 8px 10px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      line-height: 1.5;
      cursor: pointer;
    }
    .suggestion-item:hover {
      border-color: #7c3aed;
      box-shadow: 0 0 0 1px rgba(124,58,237,0.2);
    }
    .suggestion-footer {
      margin-top: 8px;
      font-size: 10px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* === API 키 입력 모달 === */
    .apikey-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .apikey-modal {
      width: 360px;
      max-width: calc(100% - 40px);
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15,23,42,0.45);
      padding: 18px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .apikey-title {
      font-size: 16px;
      font-weight: 600;
    }
    .apikey-desc {
      font-size: 12px;
      color: #4b5563;
    }
    .apikey-input {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
      width: 100%;
    }
    .apikey-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #6b7280;
    }
    .apikey-button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg,#6366f1,#ec4899);
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- API 키 입력 모달 -->
  <div id="apikeyOverlay" class="apikey-overlay">
    <div class="apikey-modal">
      <div class="apikey-title">OpenAI API 키 입력</div>
      <div class="apikey-desc">
        이 프로토타입은 OpenAI API를 사용합니다.<br />
        <b>sk-</b>로 시작하는 개인 키를 입력하셔야 테스트가 가능합니다.<br />
        (키는 브라우저에만 저장되며 서버로 전송되지 않습니다.)
      </div>
      <input
        id="apikeyInput"
        class="apikey-input"
        type="password"
        placeholder="sk-로 시작하는 API 키"
      />
      <div class="apikey-footer">
        <span>팀 내부 테스트용으로만 사용해주세요.</span>
        <button id="apikeyButton" class="apikey-button">시작하기</button>
      </div>
    </div>
  </div>

  <div class="kakao-window">

    <!-- HEADER -->
    <div class="kakao-header">
      <div class="kakao-header-left">
        <div class="profile-circle">
          <img src="leader_profile.png" alt="리더 프로필" />
        </div>
        <div class="chat-title">정경태 팀장님</div>
        <div class="member-count">2</div>
      </div>
      <div class="kakao-header-right"></div>
    </div>

    <!-- 문장 교정 팝업 -->
    <div id="suggestionPopup" class="suggestion-popup">
      <div class="suggestion-header">
        <div class="suggestion-header-left">
          <div class="suggestion-title">LinguaOS</div>
          <div class="suggestion-sub">TONE UP: 공손하게</div>
        </div>
        <div id="suggestionClose" class="suggestion-close">✕</div>
      </div>
      <div class="suggestion-body">
        <div id="suggestionInfo" class="suggestion-info"></div>
        <div id="suggestionList" class="suggestion-list"></div>
        <div class="suggestion-footer">
          <span>클릭하면 메시지에 적용됩니다.</span>
          <span>자동 교정 · 미전송</span>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chatBody" class="chat-body"></div>

    <!-- INPUT -->
    <div class="input-bar">
      <div class="input-main">
        <textarea id="messageInput" placeholder="메시지 입력"></textarea>
        <button id="sendBtn">전송</button>
      </div>
    </div>
  </div>

  <script>
    let apiKey = "";

    const API_URL = "https://api.openai.com/v1/chat/completions";
    const MODEL = "gpt-4.1-mini";

    const chatBody = document.getElementById("chatBody");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    const suggestionPopup = document.getElementById("suggestionPopup");
    const suggestionList = document.getElementById("suggestionList");
    const suggestionInfo = document.getElementById("suggestionInfo");
    const suggestionClose = document.getElementById("suggestionClose");

    const apikeyOverlay = document.getElementById("apikeyOverlay");
    const apikeyInput = document.getElementById("apikeyInput");
    const apikeyButton = document.getElementById("apikeyButton");

    let messages = [
      {
        role: "system",
        content: `
당신은 한국 IT 회사의 현실적인 팀장 "정경태"이다.

[말투/성격]
- 반말이며 직설적이고 짧게 말한다.
- 예의·업무 매너·책임감 부족을 매우 민감하게 본다.
- 맞춤법/띄어쓰기는 거슬리는 수준이 아니면 넘어간다.
- 단어 뜻·상황 이해 부족이 보이면 날카롭게 짚어낸다.
- 화를 내지만 인신공격·욕설은 절대 하지 않는다.
- 문학적·교훈적 말투는 절대 사용하지 않는다.

[지적 기준]
다음 항목 중 하나라도 문제가 보이면 짧게 지적한다.
1) 비즈니스 용어 오남용
2) 문장이 모호하거나 목적이 흐림
3) 예의 부족, 상대 배려 부족
4) 단어 뜻 오해 또는 논리적 비약
5) 상황 설명 없이 던지는 질문

지적은 짧고 명확하게 한다.
그러나 절대 ‘올바른 표현’이나 ‘문장 개선안’은 제공하지 않는다.

[대화 지속 규칙 — 매우 중요]
지적을 한 뒤 반드시 다음 중 하나를 한다:
- 사용자의 의도나 상황을 더 파악하기 위한 질문을 던진다.
- 다음 업무 단계로 자연스럽게 연결되는 질문을 한다.
- 사용자가 알아야 할 ‘맥락상의 확인 포인트’를 짚어주고 질문한다.

즉, 지적만 하고 끝내지 말고 항상 대화를 이어가라.

[금지]
- 개선안 제공 금지
- 장황한 설명 금지
- 사전적 정의 스타일 금지
- 친절한 교육자 말투 금지

당신의 목표:
사용자의 메시지에서 실질적인 커뮤니케이션 문제를 지적하되,
업무 대화가 자연스럽게 이어지도록 현실적인 상사처럼 대응하는 것이다.
        `.trim()
      }
    ];

    let suggestionTimer = null;
    let suggestionLoading = false;

    function ensureApiKey() {
      if (!apiKey) {
        alert("먼저 OpenAI API 키를 입력해 주세요.");
        apikeyOverlay.style.display = "flex";
        apikeyInput.focus();
        return false;
      }
      return true;
    }

    function nowTime() {
      const d = new Date();
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, "0");
      const ampm = h >= 12 ? "오후" : "오전";
      if (h === 0) h = 12;
      else if (h > 12) h -= 12;
      return `${ampm} ${h}:${m}`;
    }

    function appendMessage(role, text) {
      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "right" : "left");

      if (role !== "user") {
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        const img = document.createElement("img");
        img.src = "leader_profile.png";
        avatar.appendChild(img);
        row.appendChild(avatar);
      }

      const contentWrap = document.createElement("div");
      contentWrap.className = "msg-content";

      if (role !== "user") {
        const nick = document.createElement("div");
        nick.className = "nickname";
        nick.textContent = "정경태 팀장님";
        contentWrap.appendChild(nick);
      }

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "me" : "boss");
      bubble.textContent = text;
      contentWrap.appendChild(bubble);

      row.appendChild(contentWrap);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = nowTime();
      row.appendChild(time);

      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // === 상사에게 실제 전송 ===
    async function sendToBoss(text) {
      if (!ensureApiKey()) return;

      appendMessage("user", text);
      messages.push({ role: "user", content: text });

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: MODEL,
            messages,
            temperature: 0.7
          })
        });

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content?.trim() || "응답 없음";
        appendMessage("boss", reply);
        messages.push({ role: "assistant", content: reply });
      } catch (e) {
        console.error(e);
        appendMessage("boss", "API 오류 발생.");
      }
    }

    // === 문장 교정 제안 ===
    async function requestSuggestions(text) {
      if (!text || suggestionLoading) return;
      if (!ensureApiKey()) return;
      suggestionLoading = true;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: MODEL,
            messages: [
              {
                role: "system",
                content: `
당신은 한국어 비즈니스 메신저 문장을 다듬는 보조 도구입니다.

목표:
- 사용자가 쓴 문장을 더 공손하고 명확한 비즈니스 톤으로 바꿔 준다.
- 한국 IT 회사 팀장 "정경태"가 봐도 지적할 부분이 없도록,
  예의·명확성·책임감·모호성 제거를 기준으로 문장을 다듬는다.
- 사용자가 단어를 잘못 이해했거나 날짜/용어를 틀리게 쓴 경우,
  그 오해를 짧게 짚어주는 정보성 경고 문장을 함께 제공할 수 있다.
  (예: "금일은 오늘이라는 뜻입니다." 같은 한 줄 설명)

출력 형식 (반드시 이 JSON 형식만 사용):
{
  "explanation": "단어/표현에 대한 짧은 경고나 해설. 없으면 빈 문자열 \"\".",
  "suggestions": ["정경태 팀장이 봐도 무난한 비즈니스 톤 문장1",
                  "정경태 팀장이 봐도 무난한 비즈니스 톤 문장2"]
}

규칙:
1) explanation은 정보 제공용 문장만 넣고, suggestions에는 넣지 않는다.
2) suggestions의 각 요소는 실제 메신저에 그대로 보낼 수 있는 완성 문장이어야 한다.
3) JSON 이외의 텍스트(설명, 코드블록, 번호 매기기 등)는 절대 추가하지 않는다.
                `.trim()
              },
              {
                role: "user",
                content: text
              }
            ],
            temperature: 0.4
          })
        });

        const data = await res.json();
        let content = data.choices?.[0]?.message?.content?.trim() || "";

        let explanation = "";
        let arr = [];

        try {
          const parsed = JSON.parse(content);
          explanation = parsed.explanation || "";
          arr = parsed.suggestions || [];
        } catch (e) {
          // 포맷이 깨진 경우를 대비한 fallback
          explanation = "";
          arr = [content];
        }

        showSuggestions(explanation, arr);
      } catch (e) {
        console.error(e);
      } finally {
        suggestionLoading = false;
      }
    }

    function showSuggestions(explanation, list) {
      // 정보성 경고
      if (explanation && explanation.trim()) {
        suggestionInfo.textContent = explanation.trim();
        suggestionInfo.style.display = "block";
      } else {
        suggestionInfo.textContent = "";
        suggestionInfo.style.display = "none";
      }

      // 후보 문장
      suggestionList.innerHTML = "";
      list.forEach((s) => {
        if (!s) return;
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.textContent = s;
        item.addEventListener("click", () => {
          messageInput.value = s;
          hideSuggestions();
          messageInput.focus();
          messageInput.setSelectionRange(s.length, s.length);
        });
        suggestionList.appendChild(item);
      });

      if (list.length > 0 || (explanation && explanation.trim())) {
        suggestionPopup.style.display = "block";
      }
    }

    function hideSuggestions() {
      suggestionPopup.style.display = "none";
    }

    // 입력 시 1초 후 자동 교정 (디바운스)
    messageInput.addEventListener("input", () => {
      const text = messageInput.value.trim();

      if (suggestionTimer) {
        clearTimeout(suggestionTimer);
      }

      if (!text) {
        hideSuggestions();
        return;
      }

      suggestionTimer = setTimeout(() => {
        requestSuggestions(text);
      }, 1000);
    });

    suggestionClose.addEventListener("click", hideSuggestions);

    sendBtn.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (!text) return;
      messageInput.value = "";
      hideSuggestions();      // 전송하면 교정 팝업 무조건 닫기
      sendToBoss(text);
    });

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // API 키 모달
    apikeyButton.addEventListener("click", () => {
      const value = apikeyInput.value.trim();
      if (!value) {
        alert("API 키를 입력해 주세요.");
        return;
      }
      apiKey = value;
      apikeyOverlay.style.display = "none";
    });

    apikeyInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        apikeyButton.click();
      }
    });

    // 첫 메시지
    appendMessage("boss", "뭐 할 말 있나?");
    apikeyInput.focus();
  </script>
</body>
</html>
